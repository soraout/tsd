<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>QR → EAN-13</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:16px; background:#f7f7fb; color:#111; }
    h1 { margin:8px 0 12px; font-size:18px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    #reader { width:100%; max-width:420px; margin:10px 0; border-radius:8px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .card { background:white; border-radius:10px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:12px; }
    label { font-size:13px; color:#444; display:block; margin-bottom:6px; }
    input[type="text"] { width:100%; padding:10px; font-size:16px; border:1px solid #ddd; border-radius:6px; }
    button { padding:10px 12px; border-radius:8px; border:0; background:#0b66ff; color:white; font-weight:600; }
    button.secondary { background:#6b7280; }
    #barcode { display:block; margin:12px auto; }
    .small { font-size:13px; color:#666; }
    footer { font-size:13px; color:#666; margin-top:8px; }
    .controls { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .status { margin-top:8px; font-size:13px; color:#0b66ff; }
    .danger { color:#c02626; }
  </style>

  <script src="https://unpkg.com/html5-qrcode@2.4.6/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <h1>QR → EAN-13 (сканер + генератор)</h1>

  <div class="card">
    <div id="reader"></div>
    <div class="small">Нажмите «Start camera», чтобы разрешить доступ к камере. Приложение автоматически извлекает цифры из QR.</div>
    <div style="margin-top:8px;" class="controls">
      <button id="startBtn">Start camera</button>
      <button id="stopBtn" class="secondary">Stop</button>
      <button id="flipBtn" class="secondary">Switch camera</button>
    </div>
    <div id="camStatus" class="status"></div>
  </div>

  <div class="card">
    <label>Содержимое QR (извлечённое):</label>
    <input id="rawText" type="text" placeholder="Тут появится текст из QR" />
    <div style="height:8px;"></div>
    <label>Цифры, извлечённые из QR (можно изменить вручную):</label>
    <input id="digitText" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Только цифры" />
    <div style="margin-top:8px;" class="row">
      <button id="genBtn">Сгенерировать EAN-13</button>
      <button id="validateBtn" class="secondary">Проверить EAN-13 (если 13 цифр)</button>
      <button id="clearBtn" class="secondary">Очистить</button>
    </div>
    <div id="msg" class="small"></div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <label>Сгенерированный номер EAN-13:</label>
    <div class="row">
      <input id="ean13" type="text" readonly style="font-weight:700; font-size:18px;" />
      <div style="flex:1"></div>
      <button id="copyBtn">Копировать</button>
    </div>

    <svg id="barcode" width="320" height="140"></svg>

    <div class="controls">
      <button id="downloadPng">Скачать PNG</button>
      <button id="downloadSvg" class="secondary">Скачать SVG</button>
    </div>

    <div id="validMsg" class="small"></div>
  </div>

  <footer>
    Как работает: приложение извлекает цифры из QR (весь текст — фильтруется до цифр). Если найдено ≥12 цифр — берём первые 12 для расчёта контрольной цифры и формируем EAN-13. Если найдено 13 цифр — проверяем контрольную цифру и при необходимости подсчитываем заново (покажем уведомление). Если найдено <12 — поле для ручной добивки/правки.
  </footer>

<script>
  function onlyDigits(s){ return (s||"").replace(/\D/g,''); }
  function calcEAN13CheckDigit(first12){
    if(!/^[0-9]{12}$/.test(first12)) return null;
    let sum = 0;
    for(let i=0;i<12;i++){ const d = Number(first12[i]); const weight = (i%2===0)?1:3; sum += d * weight; }
    const mod = sum % 10; const check = (mod===0)?0:(10-mod); return String(check);
  }
  function validateEAN13(full13){
    if(!/^[0-9]{13}$/.test(full13)) return {ok:false, reason:'не 13 цифр'};
    const first12 = full13.slice(0,12);
    const chk = calcEAN13CheckDigit(first12);
    return {ok:chk===full13[12], expected:chk, actual:full13[12]};
  }
  const startBtn=document.getElementById('startBtn'),stopBtn=document.getElementById('stopBtn'),flipBtn=document.getElementById('flipBtn'),
  readerDiv=document.getElementById('reader'),camStatus=document.getElementById('camStatus'),
  rawText=document.getElementById('rawText'),digitText=document.getElementById('digitText'),
  genBtn=document.getElementById('genBtn'),validateBtn=document.getElementById('validateBtn'),
  clearBtn=document.getElementById('clearBtn'),msg=document.getElementById('msg'),
  resultCard=document.getElementById('resultCard'),ean13Input=document.getElementById('ean13'),
  barcodeSvg=document.getElementById('barcode'),copyBtn=document.getElementById('copyBtn'),
  downloadPng=document.getElementById('downloadPng'),downloadSvg=document.getElementById('downloadSvg'),
  validMsg=document.getElementById('validMsg');
  let html5QrCode=null,currentCameraId=null,cameraList=[];
  async function listCameras(){ try{const d=await Html5Qrcode.getCameras();cameraList=d||[];return cameraList;}catch(e){return[];}}
  async function startScanner(id){
    if(!html5QrCode){html5QrCode=new Html5Qrcode("reader",false);}
    const config={fps:10,qrbox:{width:300,height:300},rememberLastUsedCamera:true};
    try{
      camStatus.textContent="Запуск камеры...";
      await html5QrCode.start(id,config,msg=>{
        camStatus.textContent="QR найден";rawText.value=msg;digitText.value=onlyDigits(msg);
        msg.textContent="Цифры извлечены. Нажмите «Сгенерировать EAN-13».";
      });
      camStatus.textContent="Камера запущена";
    }catch(e){camStatus.innerHTML='<span class="danger">Ошибка: '+e+'</span>';}
  }
  async function stopScanner(){if(html5QrCode){try{await html5QrCode.stop();}catch(e){}try{html5QrCode.clear();}catch(e){}html5QrCode=null;readerDiv.innerHTML="";camStatus.textContent="Камера остановлена";}}
  startBtn.onclick=async()=>{startBtn.disabled=true;const cams=await listCameras();if(!cams.length){camStatus.innerHTML='<span class="danger">Камеры не найдены.</span>';startBtn.disabled=false;return;}
    if(!currentCameraId){const back=cams.find(c=>/back|rear|environment|зад/i.test(c.label));currentCameraId=(back&&back.id)?back.id:cams[0].id;}
    await startScanner(currentCameraId);startBtn.disabled=false;};
  stopBtn.onclick=async()=>{await stopScanner();};
  flipBtn.onclick=async()=>{const cams=await listCameras();if(cams.length<2){camStatus.textContent="Других камер нет.";return;}
    let i=cams.findIndex(c=>c.id===currentCameraId);i=(i+1)%cams.length;currentCameraId=cams[i].id;await stopScanner();await startScanner(currentCameraId);};
  genBtn.onclick=()=>{const d=onlyDigits(digitText.value);if(d.length>=12){const f=d.slice(0,12),c=calcEAN13CheckDigit(f),e=f+c;showResult(e);}else{msg.innerHTML='<span class="danger">Нужно ≥12 цифр.</span>';}};
  validateBtn.onclick=()=>{const d=onlyDigits(digitText.value);if(d.length===13){const v=validateEAN13(d);if(v.ok){msg.textContent="EAN-13 валиден.";showResult(d);}else{msg.textContent="Контрольная цифра неверна. Ожидается "+v.expected;showResult(d.slice(0,12)+v.expected);}}else{msg.textContent="Введите 13 цифр."}};
  clearBtn.onclick=()=>{rawText.value="";digitText.value="";msg.textContent="";resultCard.style.display='none';};
  function showResult(e){ean13Input.value=e;JsBarcode("#barcode",e,{format:"ean13",displayValue:true,fontSize:18,width:2,height:80,margin:10});resultCard.style.display='block';}
  copyBtn.onclick=async()=>{await navigator.clipboard.writeText(ean13Input.value);copyBtn.textContent="Скопировано!";setTimeout(()=>copyBtn.textContent="Копировать",1200);};
  downloadSvg.onclick=()=>{const s=new XMLSerializer().serializeToString(barcodeSvg);const b=new Blob([s],{type:"image/svg+xml;charset=utf-8"});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=ean13Input.value+'.svg';a.click();URL.revokeObjectURL(u);};
  downloadPng.onclick=()=>{const s=new XMLSerializer().serializeToString(barcodeSvg);const i=new Image();const b=new Blob([s],{type:'image/svg+xml;charset=utf-8'});const u=URL.createObjectURL(b);i.onload=()=>{const c=document.createElement('canvas');c.width=i.width*2;c.height=i.height*2;const x=c.getContext('2d');x.fillStyle='#fff';x.fillRect(0,0,c.width,c.height);x.drawImage(i,0,0,c.width,c.height);c.toBlob(p=>{const l=document.createElement('a');l.href=URL.createObjectURL(p);l.download=ean13Input.value+'.png';l.click();URL.revokeObjectURL(l.href);},'image/png');URL.revokeObjectURL(u);};i.src=u;};
  rawText.addEventListener('input',()=>{digitText.value=onlyDigits(rawText.value);});
  if(location.protocol==='file:'){camStatus.innerHTML='<span class="danger">Открой через HTTPS: доступ к камере из file:// запрещён.</span>';}
</script>
</body>
</html>